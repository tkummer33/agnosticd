---
# Below config is applied once control plane and bootstrap nodes are provisioned. 
install_lb_config:
  stats_page:
    enabled: True
    host_port: 8080
    username: admin
    password: admin
  frontends:
    - lb_name: "{{ guid }}-6443"
      lb_host_port: 6443
      lb_mode: tcp
    - lb_name: "{{ guid }}-22623"
      lb_host_port: 22623
      lb_mode: tcp
  lb_entries:
    - lb_match_port: 6443
      lb_mode: tcp
      backends:
        - host: "bootstrap.{{ guid }}.{{ osp_cluster_dns_zone }}"
          port: 6443
        - host: "master-0.{{ guid }}.{{ osp_cluster_dns_zone }}"
          port: 6443
        - host: "master-1.{{ guid }}.{{ osp_cluster_dns_zone }}"
          port: 6443
        - host: "master-2.{{ guid }}.{{ osp_cluster_dns_zone }}"
          port: 6443
    - lb_match_port: 22623
      lb_mode: tcp
      backends:
        - host: "bootstrap.{{ guid }}.{{ osp_cluster_dns_zone }}"
          port: 22623
        - host: "master-0.{{ guid }}.{{ osp_cluster_dns_zone }}"
          port: 22623
        - host: "master-1.{{ guid }}.{{ osp_cluster_dns_zone }}"
          port: 22623
        - host: "master-2.{{ guid }}.{{ osp_cluster_dns_zone }}"
          port: 22623

# section below removes bootstrap resources from the loadbalancer after successful bootstrap
post_install_lb_config:
  stats_page:
    enabled: True
    host_port: 8080
    username: admin
    password: admin
  frontends:
    - lb_name: "{{ guid }}-6443"
      lb_host_port: 6443
      lb_mode: tcp
    - lb_name: "{{ guid }}-22623"
      lb_host_port: 22623
      lb_mode: tcp
  lb_entries:
    - lb_match_port: 6443
      lb_mode: tcp
      backends:
        - host: "master-0.{{ guid }}.{{ osp_cluster_dns_zone }}"
          port: 6443
        - host: "master-1.{{ guid }}.{{ osp_cluster_dns_zone }}"
          port: 6443
        - host: "master-2.{{ guid }}.{{ osp_cluster_dns_zone }}"
          port: 6443
    - lb_match_port: 22623
      lb_mode: tcp
      backends:
        - host: "master-0.{{ guid }}.{{ osp_cluster_dns_zone }}"
          port: 22623
        - host: "master-1.{{ guid }}.{{ osp_cluster_dns_zone }}"
          port: 22623
        - host: "master-2.{{ guid }}.{{ osp_cluster_dns_zone }}"
          port: 22623

# this section adds worker nodes to the loadbalancer          
final_lb_config:
  stats_page:
    enabled: True
    host_port: 8080
    username: admin
    password: admin
  frontends:
    - lb_name: "{{ guid }}-80"
      lb_host_port: 80
      lb_mode: tcp
    - lb_name: "{{ guid }}-443"
      lb_host_port: 443
      lb_mode: tcp
    - lb_name: "{{ guid }}-6443"
      lb_host_port: 6443
      lb_mode: tcp
    - lb_name: "{{ guid }}-22623"
      lb_host_port: 22623
      lb_mode: tcp
  lb_entries:
    - lb_match_port: 80
      lb_mode: tcp
      backends:
        - host: "worker-0.{{ guid }}.{{ osp_cluster_dns_zone }}"
          port: 80
        - host: "worker-1.{{ guid }}.{{ osp_cluster_dns_zone }}"
          port: 80
    - lb_match_port: 443
      lb_mode: tcp
      backends:
        - host: "worker-0.{{ guid }}.{{ osp_cluster_dns_zone }}"
          port: 443
        - host: "worker-1.{{ guid }}.{{ osp_cluster_dns_zone }}"
          port: 443
    - lb_match_port: 6443
      lb_mode: tcp
      backends:
        - host: "master-0.{{ guid }}.{{ osp_cluster_dns_zone }}"
          port: 6443
        - host: "master-1.{{ guid }}.{{ osp_cluster_dns_zone }}"
          port: 6443
        - host: "master-2.{{ guid }}.{{ osp_cluster_dns_zone }}"
          port: 6443
    - lb_match_port: 22623
      lb_mode: tcp
      backends:
        - host: "master-0.{{ guid }}.{{ osp_cluster_dns_zone }}"
          port: 22623
        - host: "master-1.{{ guid }}.{{ osp_cluster_dns_zone }}"
          port: 22623
        - host: "master-2.{{ guid }}.{{ osp_cluster_dns_zone }}"
          port: 22623
